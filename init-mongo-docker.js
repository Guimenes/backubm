// Script de inicializa√ß√£o do MongoDB para Docker
// Este arquivo ser√° executado quando o container MongoDB for criado pela primeira vez

// Conectar ao banco de dados
db = db.getSiblingDB('seminario_ubm');

print('üöÄ Iniciando configura√ß√£o do banco de dados...');

// Criar usu√°rio espec√≠fico para a aplica√ß√£o
db.createUser({
  user: 'seminario_user',
  pwd: 'seminario_pass',
  roles: [
    {
      role: 'readWrite',
      db: 'seminario_ubm'
    }
  ]
});

// Criar cole√ß√µes principais
print('üìÅ Criando cole√ß√µes...');
db.createCollection('usuarios');
db.createCollection('perfis');
db.createCollection('permissoes');
db.createCollection('locais');
db.createCollection('cursos');
db.createCollection('eventos');

// Inserir permiss√µes padr√£o
print('üîê Criando permiss√µes padr√£o...');
db.permissoes.insertMany([
  // M√≥dulo Locais
  { nome: 'Listar Locais', codigo: 'LOCAIS_LISTAR', modulo: 'locais', descricao: 'Permite visualizar a lista de locais', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Visualizar Local', codigo: 'LOCAIS_VISUALIZAR', modulo: 'locais', descricao: 'Permite ver detalhes de um local espec√≠fico', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Criar Local', codigo: 'LOCAIS_CRIAR', modulo: 'locais', descricao: 'Permite criar novos locais', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Editar Local', codigo: 'LOCAIS_EDITAR', modulo: 'locais', descricao: 'Permite editar locais existentes', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Excluir Local', codigo: 'LOCAIS_EXCLUIR', modulo: 'locais', descricao: 'Permite excluir locais', ativo: true, createdAt: new Date(), updatedAt: new Date() },

  // M√≥dulo Eventos
  { nome: 'Listar Eventos', codigo: 'EVENTOS_LISTAR', modulo: 'eventos', descricao: 'Permite visualizar a lista de eventos', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Visualizar Evento', codigo: 'EVENTOS_VISUALIZAR', modulo: 'eventos', descricao: 'Permite ver detalhes de um evento espec√≠fico', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Criar Evento', codigo: 'EVENTOS_CRIAR', modulo: 'eventos', descricao: 'Permite criar novos eventos', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Editar Evento', codigo: 'EVENTOS_EDITAR', modulo: 'eventos', descricao: 'Permite editar eventos existentes', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Excluir Evento', codigo: 'EVENTOS_EXCLUIR', modulo: 'eventos', descricao: 'Permite excluir eventos', ativo: true, createdAt: new Date(), updatedAt: new Date() },

  // M√≥dulo Cursos
  { nome: 'Listar Cursos', codigo: 'CURSOS_LISTAR', modulo: 'cursos', descricao: 'Permite visualizar a lista de cursos', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Visualizar Curso', codigo: 'CURSOS_VISUALIZAR', modulo: 'cursos', descricao: 'Permite ver detalhes de um curso espec√≠fico', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Criar Curso', codigo: 'CURSOS_CRIAR', modulo: 'cursos', descricao: 'Permite criar novos cursos', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Editar Curso', codigo: 'CURSOS_EDITAR', modulo: 'cursos', descricao: 'Permite editar cursos existentes', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Excluir Curso', codigo: 'CURSOS_EXCLUIR', modulo: 'cursos', descricao: 'Permite excluir cursos', ativo: true, createdAt: new Date(), updatedAt: new Date() },

  // M√≥dulo Usu√°rios
  { nome: 'Listar Usu√°rios', codigo: 'USUARIOS_LISTAR', modulo: 'usuarios', descricao: 'Permite visualizar a lista de usu√°rios', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Visualizar Usu√°rio', codigo: 'USUARIOS_VISUALIZAR', modulo: 'usuarios', descricao: 'Permite ver detalhes de um usu√°rio espec√≠fico', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Criar Usu√°rio', codigo: 'USUARIOS_CRIAR', modulo: 'usuarios', descricao: 'Permite criar novos usu√°rios', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Editar Usu√°rio', codigo: 'USUARIOS_EDITAR', modulo: 'usuarios', descricao: 'Permite editar usu√°rios existentes', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Excluir Usu√°rio', codigo: 'USUARIOS_EXCLUIR', modulo: 'usuarios', descricao: 'Permite excluir usu√°rios', ativo: true, createdAt: new Date(), updatedAt: new Date() },

  // M√≥dulo Permiss√µes
  { nome: 'Listar Permiss√µes', codigo: 'PERMISSOES_LISTAR', modulo: 'permissoes', descricao: 'Permite visualizar a lista de permiss√µes', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Visualizar Permiss√£o', codigo: 'PERMISSOES_VISUALIZAR', modulo: 'permissoes', descricao: 'Permite ver detalhes de uma permiss√£o espec√≠fica', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Criar Permiss√£o', codigo: 'PERMISSOES_CRIAR', modulo: 'permissoes', descricao: 'Permite criar novas permiss√µes', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Editar Permiss√£o', codigo: 'PERMISSOES_EDITAR', modulo: 'permissoes', descricao: 'Permite editar permiss√µes existentes', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Excluir Permiss√£o', codigo: 'PERMISSOES_EXCLUIR', modulo: 'permissoes', descricao: 'Permite excluir permiss√µes', ativo: true, createdAt: new Date(), updatedAt: new Date() },

  // M√≥dulo Perfis
  { nome: 'Listar Perfis', codigo: 'PERFIS_LISTAR', modulo: 'permissoes', descricao: 'Permite visualizar a lista de perfis', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Visualizar Perfil', codigo: 'PERFIS_VISUALIZAR', modulo: 'permissoes', descricao: 'Permite ver detalhes de um perfil espec√≠fico', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Criar Perfil', codigo: 'PERFIS_CRIAR', modulo: 'permissoes', descricao: 'Permite criar novos perfis', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Editar Perfil', codigo: 'PERFIS_EDITAR', modulo: 'permissoes', descricao: 'Permite editar perfis existentes', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Excluir Perfil', codigo: 'PERFIS_EXCLUIR', modulo: 'permissoes', descricao: 'Permite excluir perfis', ativo: true, createdAt: new Date(), updatedAt: new Date() },

  // M√≥dulo Relat√≥rios
  { nome: 'Visualizar Relat√≥rios', codigo: 'RELATORIOS_VISUALIZAR', modulo: 'relatorios', descricao: 'Permite visualizar relat√≥rios do sistema', ativo: true, createdAt: new Date(), updatedAt: new Date() },
  { nome: 'Gerar Relat√≥rios', codigo: 'RELATORIOS_GERAR', modulo: 'relatorios', descricao: 'Permite gerar relat√≥rios personalizados', ativo: true, createdAt: new Date(), updatedAt: new Date() }
]);

// Buscar todas as permiss√µes criadas
const todasPermissoes = db.permissoes.find({ ativo: true }).toArray();
const permissoesIds = todasPermissoes.map(p => p._id);

print('üë• Criando perfis padr√£o...');

// Criar perfil Administrador com todas as permiss√µes
const perfilAdmin = {
  nome: 'Administrador',
  descricao: 'Acesso total ao sistema',
  permissoes: permissoesIds,
  ativo: true,
  createdAt: new Date(),
  updatedAt: new Date()
};
db.perfis.insertOne(perfilAdmin);

// Criar perfil Organizador (sem permiss√µes de usu√°rios e permiss√µes)
const permissoesOrganizador = todasPermissoes
  .filter(p => !p.codigo.startsWith('USUARIOS_') && !p.codigo.startsWith('PERMISSOES_') && !p.codigo.startsWith('PERFIS_'))
  .map(p => p._id);

const perfilOrganizador = {
  nome: 'Organizador',
  descricao: 'Acesso para organiza√ß√£o de eventos',
  permissoes: permissoesOrganizador,
  ativo: true,
  createdAt: new Date(),
  updatedAt: new Date()
};
db.perfis.insertOne(perfilOrganizador);

// Criar perfil Participante (apenas visualiza√ß√£o)
const permissoesParticipante = todasPermissoes
  .filter(p => p.codigo.includes('_LISTAR') || p.codigo.includes('_VISUALIZAR'))
  .filter(p => !p.codigo.startsWith('USUARIOS_') && !p.codigo.startsWith('PERMISSOES_') && !p.codigo.startsWith('PERFIS_'))
  .map(p => p._id);

const perfilParticipante = {
  nome: 'Participante',
  descricao: 'Acesso apenas para visualiza√ß√£o',
  permissoes: permissoesParticipante,
  ativo: true,
  createdAt: new Date(),
  updatedAt: new Date()
};
db.perfis.insertOne(perfilParticipante);

// Buscar o perfil administrador criado
const adminPerfil = db.perfis.findOne({ nome: 'Administrador' });

print('üë§ Criando usu√°rio administrador...');

// Criar usu√°rio administrador padr√£o
// Senha: 123456 (ser√° hasheada pela aplica√ß√£o, n√£o pelo script)
db.usuarios.insertOne({
  nome: 'Administrador do Sistema',
  email: 'admin@ubm.br',
  senha: '123456', // Senha em texto plano para ser hasheada pela aplica√ß√£o
  perfil: adminPerfil._id,
  ativo: true,
  createdAt: new Date(),
  updatedAt: new Date()
});

// Inserir dados de exemplo
print('üìä Inserindo dados de exemplo...');

// Locais de exemplo
db.locais.insertMany([
  {
    codigo: 'AUD001',
    nome: 'Audit√≥rio Principal',
    descricao: 'Audit√≥rio principal com capacidade para 200 pessoas',
    capacidade: 200,
    tipo: 'Audit√≥rio',
    ativo: true,
    createdAt: new Date(),
    updatedAt: new Date()
  },
  {
    codigo: 'LAB001',
    nome: 'Laborat√≥rio de Inform√°tica 1',
    descricao: 'Laborat√≥rio equipado com 30 computadores',
    capacidade: 30,
    tipo: 'Laborat√≥rio',
    ativo: true,
    createdAt: new Date(),
    updatedAt: new Date()
  },
  {
    codigo: 'SAL101',
    nome: 'Sala de Aula 101',
    descricao: 'Sala de aula padr√£o para 40 alunos',
    capacidade: 40,
    tipo: 'Sala de Aula',
    ativo: true,
    createdAt: new Date(),
    updatedAt: new Date()
  }
]);

// Cursos de exemplo
db.cursos.insertMany([
  {
    codigo: 'ENG001',
    nome: 'Engenharia Civil',
    descricao: 'Curso de Engenharia Civil',
    ativo: true,
    createdAt: new Date(),
    updatedAt: new Date()
  },
  {
    codigo: 'ADM001',
    nome: 'Administra√ß√£o',
    descricao: 'Curso de Administra√ß√£o',
    ativo: true,
    createdAt: new Date(),
    updatedAt: new Date()
  },
  {
    codigo: 'DIR001',
    nome: 'Direito',
    descricao: 'Curso de Direito',
    ativo: true,
    createdAt: new Date(),
    updatedAt: new Date()
  }
]);

// Eventos de exemplo
const auditorio = db.locais.findOne({ codigo: 'AUD001' });
const curso1 = db.cursos.findOne({ codigo: 'ENG001' });

db.eventos.insertMany([
  {
    titulo: 'Palestra: Inova√ß√µes na Engenharia Civil',
    descricao: 'Palestra sobre as mais recentes inova√ß√µes tecnol√≥gicas na √°rea de engenharia civil',
    dataInicio: new Date('2025-05-15T09:00:00Z'),
    dataFim: new Date('2025-05-15T11:00:00Z'),
    local: auditorio._id,
    curso: curso1._id,
    palestrante: 'Dr. Jo√£o Silva',
    tipo: 'Palestra',
    ativo: true,
    createdAt: new Date(),
    updatedAt: new Date()
  }
]);

print('‚úÖ Banco de dados inicializado com sucesso!');
print('');
print('üìã Resumo da inicializa√ß√£o:');
print('   üîê Permiss√µes: ' + db.permissoes.countDocuments() + ' criadas');
print('   üë• Perfis: ' + db.perfis.countDocuments() + ' criados');
print('   üë§ Usu√°rios: ' + db.usuarios.countDocuments() + ' criados');
print('   üìç Locais: ' + db.locais.countDocuments() + ' criados');
print('   üìö Cursos: ' + db.cursos.countDocuments() + ' criados');
print('   üìÖ Eventos: ' + db.eventos.countDocuments() + ' criados');
print('');
print('üë§ Login do Administrador:');
print('   üìß Email: admin@ubm.br');
print('   üîí Senha: 123456');
print('');
print('üöÄ Sistema pronto para uso!');
